import React, { useEffect, useMemo, useRef, useState, createContext, useContext } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Search, Settings, ChevronLeft, ChevronRight, Plus, Printer, ExternalLink, ArrowLeftRight, UserPlus, Ticket, Loader2 } from "lucide-react";

/**
 * Mini-RepairShopr, React + TailwindCSS single-file app
 *
 * Highlights:
 * - API client for RepairShopr REST (base URL + API key header)
 * - URL-driven views to mirror Unity app routing:
 *   "/" ticket list
 *   "/$<customerId>" view customer
 *   "/$<customerId>?newticket" new ticket for customer
 *   "/$<customerId>?edit" edit customer
 *   "/&<ticketId>" view ticket by id
 *   "/&<ticketId>?edit" edit ticket by id
 *   "/#<ticketNumber>" view ticket by number
 *   "/newcustomer" new customer
 * - Ticket list with status chips + filter, search box, tabs (Tickets / Customers)
 * - New/Edit Ticket flow replicating Unity fields (device, brand, model, color, problems, how long, password, items left, data)
 * - Hotkeys: H (home), S (focus search), N (new customer), Left/Right arrows (switch tab), Enter (open row)
 * - Print label stub using window.print for a label preview area
 * - Polished UI via Tailwind; animations via Framer Motion
 *
 * NOTE: This is front-end only. Ensure CORS is allowed for your RepairShopr domain when used from the browser.
 *       You will need to paste your API key in Settings.
 */

/*************************
 * Statuses / Colors (from Unity UsefullMethods)
 *************************/
const STATUSES = [
  "Diagnosing",
  "Finding Price",
  "Approval Needed",
  "Waiting for Parts",
  "Waiting (Other)",
  "In Progress",
  "Ready",
  "Resolved",
];
const STATUS_COLORS = [
  "#2DB490",
  "#1E793E",
  "#1E4679",
  "#B6B72E",
  "#35B2D4",
  "#7B1F20",
  "#2CB04F",
  "#D4AF35",
];

/*************************
 * New Ticket Presets (from Unity NewTicketManager)
 *************************/
const DEVICES = ["Phone", "Tablet", "Laptop", "Desktop", "All in one", "Watch", "Console", ""]; // last = other
const BRANDS = [
  ["iPhone", "Samsung", "Moto", "LG", "Pixel", "Revvl", "OnePlus", ""],
  ["iPad", "Samsung", ""],
  ["MacBook", "HP", "Dell", "Lenovo", "Asus", "Acer", "Toshiba", ""],
  ["Apple", "HP", "Dell", "Lenovo", "Asus", "Acer", "Toshiba", ""],
  ["iMac", "HP", "Dell", "Lenovo", "Asus", "Acer", "Toshiba", ""],
  ["Apple", ""],
  ["PlayStation", "XBox", "Switch", ""],
  [""]
];
const PROBLEMS = [
  ["LCD", "Battery", "Charge port", "Back glass", "Camera lens", "Camera issues", "Speaker issues", "Microphone", "No power", "No display", "Won't boot", "Liquid damage", "Reset"],
  ["LCD", "Battery", "Charge port", "Camera lens", "Camera issues", "Speaker issues", "No power", "No display", "Won't boot", "Liquid damage", "Reset"],
  ["LCD", "No power", "No display", "Won't boot", "Install Kaspersky", "Install SSD", "Slow", "Hinges", "Keyboard", "Install Office", "Clean virus", "Liquid damage", "Reset"],
  ["No power", "No display", "Won't boot", "Install Kaspersky", "Install SSD", "Slow", "Install Office", "Clean virus", "Reset"],
  ["No power", "No display", "Won't boot", "Install Kaspersky", "Install SSD", "Slow", "Install Office", "Clean virus", "Reset"],
  ["LCD", "Battery", "Connection issues", "No power", "No display", "Won't boot", "Liquid damage", "Reset"],
  ["LCD", "Battery", "Charge port", "No power", "No display", "Won't boot", "Reset"],
  []
];
const HOW_LONG = ["30 min", "45 min", "2 hours", "4 hours", "1 day", "3 days", ""];
const HOW_LONG_MIN = [30, 45, 120, 240, 1440, 4320, 0];
const ITEMS_LEFT = ["Charger", "Case", ""];
const NEED_DATA = ["No data", "Save data", "Save data & programs", ""];
const COLORS = [
  "Purple","Orange","Black","Gray","White","Yellow","Pink","Blue","Brown","Green","Red","Silver","Gold","Rose Gold"
];

/*************************
 * API layer
 *************************/
const ApiCtx = createContext(null);
const useApi = () => useContext(ApiCtx);

function ApiProvider({ children }) {
  const [baseUrl, setBaseUrl] = useState("https://YOURSUBDOMAIN.repairshopr.com/api/v1");
  const [apiKey, setApiKey] = useState("");

  const client = useMemo(() => {
    async function send(path, { method = "GET", body } = {}) {
      if (!baseUrl) throw new Error("Missing base URL");
      const res = await fetch(`${baseUrl}${path}`, {
        method,
        headers: {
          "Content-Type": "application/json",
          Authorization: apiKey || "",
        },
        body: body ? JSON.stringify(body) : undefined,
      });
      if (!res.ok) throw new Error(`${res.status} ${res.statusText}`);
      return await res.json();
    }
    return {
      baseUrl,
      setBaseUrl,
      apiKey,
      setApiKey,
      get: (p) => send(p, { method: "GET" }),
      post: (p, b) => send(p, { method: "POST", body: b }),
      put: (p, b) => send(p, { method: "PUT", body: b }),
      del: (p) => send(p, { method: "DELETE" }),
    };
  }, [baseUrl, apiKey]);

  return <ApiCtx.Provider value={client}>{children}</ApiCtx.Provider>;
}

/*************************
 * Utilities
 *************************/
function classNames(...xs) {
  return xs.filter(Boolean).join(" ");
}
function fmtDate(s) {
  try { return new Date(s).toLocaleString(); } catch { return s; }
}
function useHotkeys(map) {
  useEffect(() => {
    function onKey(e) {
      if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA')) return;
      const k = e.key.toLowerCase();
      if (map[k]) map[k](e);
    }
    window.addEventListener('keydown', onKey);
    return () => window.removeEventListener('keydown', onKey);
  }, [map]);
}

/*************************
 * Router (hash-based, mirrors Unity URL scheme)
 *************************/
function useRoute() {
  const [path, setPath] = useState(window.location.pathname + window.location.search + window.location.hash);
  useEffect(() => {
    const f = () => setPath(window.location.pathname + window.location.search + window.location.hash);
    window.addEventListener('popstate', f);
    window.addEventListener('hashchange', f);
    return () => { window.removeEventListener('popstate', f); window.removeEventListener('hashchange', f); };
  }, []);
  const navigate = (to) => {
    window.history.pushState({}, "", to);
    const ev = new Event('popstate');
    window.dispatchEvent(ev);
  };
  return { path, navigate };
}

/*************************
 * Top Bar
 *************************/
function TopBar({ title, onHome, onSearchFocus, onNewCustomer, onSettings }) {
  return (
    <div className="sticky top-0 z-30 w-full bg-white/80 backdrop-blur border-b">
      <div className="mx-auto max-w-6xl px-3 py-2 flex items-center gap-2">
        <button onClick={onHome} className="btn">Home</button>
        <h1 className="text-xl font-semibold flex-1">{title}</h1>
        <button onClick={onSearchFocus} className="icon-btn" title="Focus search (S)"><Search className="w-5 h-5"/></button>
        <button onClick={onNewCustomer} className="icon-btn" title="New Customer (N)"><UserPlus className="w-5 h-5"/></button>
        <button onClick={onSettings} className="icon-btn" title="Settings"><Settings className="w-5 h-5"/></button>
      </div>
    </div>
  );
}

/*************************
 * Settings Modal
 *************************/
function SettingsModal({ open, onClose }) {
  const api = useApi();
  if (!open) return null;
  return (
    <div className="fixed inset-0 z-40 bg-black/30 flex items-center justify-center p-4">
      <div className="w-full max-w-lg rounded-2xl bg-white shadow-xl p-6 space-y-4">
        <div className="text-lg font-semibold">Settings</div>
        <div className="space-y-2">
          <label className="block text-sm">RepairShopr Base URL</label>
          <input className="input" value={api.baseUrl} onChange={(e)=>api.setBaseUrl(e.target.value)} placeholder="https://subdomain.repairshopr.com/api/v1"/>
        </div>
        <div className="space-y-2">
          <label className="block text-sm">API Key (Authorization header)</label>
          <input className="input" value={api.apiKey} onChange={(e)=>api.setApiKey(e.target.value)} placeholder="api_key"/>
        </div>
        <div className="flex justify-end gap-2 pt-2">
          <button className="btn" onClick={onClose}>Close</button>
        </div>
      </div>
    </div>
  );
}

/*************************
 * Ticket List / Customers Tab
 *************************/
function TicketListView({ goTo, focusSearchRef }) {
  const api = useApi();
  const [tab, setTab] = useState("tickets"); // "tickets" | "customers"
  const [search, setSearch] = useState("");
  const [statusHidden, setStatusHidden] = useState(() => new Set([STATUSES[STATUSES.length-1]])); // start hiding "Resolved"
  const [items, setItems] = useState([]);
  const [loading, setLoading] = useState(false);
  const [page, setPage] = useState(1);
  const listRef = useRef(null);

  const toggleStatus = (s) => {
    const next = new Set(statusHidden);
    if (next.has(s)) next.delete(s); else next.add(s);
    setStatusHidden(next);
  };

  async function fetchTickets(reset=false) {
    setLoading(true);
    try {
      // Tickets endpoint. Support simple search via query param if available; fallback to paging.
      const q = search.trim();
      let data;
      if (q) {
        // Try tickets search by number or subject
        // Common pattern: /tickets?query=, or /tickets?number=
        // We'll try autocomplete-like behavior server-side; otherwise we filter client-side.
        data = await api.get(`/tickets?query=${encodeURIComponent(q)}&page=${reset?1:page}`);
      } else {
        data = await api.get(`/tickets?page=${reset?1:page}`);
      }
      const arr = data.tickets || data || [];
      setItems(reset ? arr : [...items, ...arr]);
      setPage(p => reset ? 1 : p);
    } catch (e) {
      console.error(e);
    } finally { setLoading(false); }
  }

  async function fetchCustomers(reset=false) {
    setLoading(true);
    try {
      const q = search.trim();
      let data;
      if (q) {
        data = await api.get(`/customers/autocomplete?query=${encodeURIComponent(q)}`);
      } else {
        data = await api.get(`/customers?page=${reset?1:page}`);
      }
      const arr = data.customers || data || [];
      setItems(reset ? arr : [...items, ...arr]);
      setPage(p => reset ? 1 : p);
    } catch (e) { console.error(e); } finally { setLoading(false); }
  }

  useEffect(()=>{ // initial load
    if (tab === "tickets") fetchTickets(true); else fetchCustomers(true);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [tab]);

  useEffect(()=>{ // search debounce
    const t = setTimeout(()=>{
      if (tab === "tickets") fetchTickets(true); else fetchCustomers(true);
    }, 300);
    return ()=>clearTimeout(t);
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [search]);

  useHotkeys({
    "h": () => goTo("/"),
    "s": () => focusSearchRef.current?.focus(),
    "n": () => goTo("/newcustomer"),
    "arrowleft": () => setTab("customers"),
    "arrowright": () => setTab("tickets"),
    "enter": () => {
      const first = listRef.current?.querySelector("[data-row]");
      first?.click();
    },
  });

  return (
    <div className="mx-auto max-w-6xl px-3 py-4">
      <div className="flex items-center gap-2 mb-3">
        <div className="inline-flex rounded-2xl border p-1 bg-white shadow-sm">
          <button className={classNames("tab", tab==="tickets" && "tab-active")} onClick={()=>setTab("tickets")}>Tickets</button>
          <button className={classNames("tab", tab==="customers" && "tab-active")} onClick={()=>setTab("customers")}>Customers</button>
        </div>
        {tab==="tickets" && (
          <div className="flex items-center gap-2 ml-auto">
            <div className="text-sm">Status filter:</div>
            <div className="flex flex-wrap gap-1">
              {STATUSES.map((s, i) => (
                <button key={s} onClick={()=>toggleStatus(s)} className="px-2 py-1 rounded-full border text-xs"
                        style={{ background: statusHidden.has(s)?"#2c2c2c":"white", color: statusHidden.has(s)?"white":"black", borderColor: STATUS_COLORS[i]}}>
                  {s}
                </button>
              ))}
            </div>
          </div>
        )}
      </div>

      <div className="relative">
        <input ref={focusSearchRef} value={search} onChange={e=>setSearch(e.target.value)} placeholder={tab==="tickets"?"Search tickets (number, subject, customer)":"Search customers (name, phone)"} className="input w-full pl-10"/>
        <Search className="w-5 h-5 absolute left-3 top-2.5"/>
      </div>

      <div className="mt-4 rounded-2xl border bg-white shadow-sm divide-y">
        <div className="grid grid-cols-12 text-xs uppercase text-gray-500 px-3 py-2">
          {tab==="tickets" ? (
            <>
              <div className="col-span-2">Number</div>
              <div className="col-span-5">Subject</div>
              <div className="col-span-2">Status</div>
              <div className="col-span-3">Customer</div>
            </>
          ) : (
            <>
              <div className="col-span-5">Name</div>
              <div className="col-span-4">Phone</div>
              <div className="col-span-3">Created</div>
            </>
          )}
        </div>
        <div ref={listRef} className="divide-y">
          <AnimatePresence>
            {tab==="tickets" && (items||[])
              .filter(t => !t.status || !statusHidden.has(t.status))
              .map((t) => (
              <motion.button
                data-row
                key={t.id}
                initial={{opacity:0, y:4}}
                animate={{opacity:1, y:0}}
                exit={{opacity:0}}
                onClick={()=>goTo(`/&${t.id}`)}
                className="grid grid-cols-12 w-full text-left hover:bg-gray-50 px-3 py-2">
                <div className="col-span-2 font-mono">#{t.number ?? t.id}</div>
                <div className="col-span-5 truncate">{t.subject}</div>
                <div className="col-span-2"><span className="px-2 py-0.5 rounded-full text-xs border" style={{borderColor: STATUS_COLORS[STATUSES.indexOf(t.status)||0]}}>{t.status}</span></div>
                <div className="col-span-3 truncate">{t.customer?.business_and_full_name ?? t.customer?.fullname}</div>
              </motion.button>
            ))}
            {tab==="customers" && (items||[]).map(c => (
              <motion.button data-row key={c.id} initial={{opacity:0, y:4}} animate={{opacity:1, y:0}} exit={{opacity:0}}
                onClick={()=>goTo(`/$${c.id}`)} className="grid grid-cols-12 w-full text-left hover:bg-gray-50 px-3 py-2">
                <div className="col-span-5 truncate">{c.business_and_full_name || c.fullname}</div>
                <div className="col-span-4">{c.phone || c.mobile || c.work_phone}</div>
                <div className="col-span-3">{fmtDate(c.created_at)}</div>
              </motion.button>
            ))}
          </AnimatePresence>
        </div>
        {loading && <div className="flex items-center justify-center p-4 text-sm gap-2"><Loader2 className="w-4 h-4 animate-spin"/> Loading…</div>}
      </div>

      <div className="flex justify-between items-center mt-3">
        <button className="btn" onClick={()=>tab==="tickets"?fetchTickets(false):fetchCustomers(false)}>
          Load more
        </button>
        <div className="text-xs text-gray-500">Hotkeys: H (home), S (search), N (new customer), ←/→ (switch tab), Enter (open first)</div>
      </div>
    </div>
  );
}

/*************************
 * Customer View / New Customer
 *************************/
function CustomerView({ id, goTo }) {
  const api = useApi();
  const [c, setC] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(()=>{
    (async()=>{
      try { const data = await api.get(`/customers/${id}`); setC(data.customer || data); } catch(e){ console.error(e);} finally{ setLoading(false);} })();
  }, [id, api]);

  if (loading) return <Loading/>;
  if (!c) return <ErrorMsg text="Customer not found"/>;

  return (
    <div className="mx-auto max-w-4xl px-3 py-4 space-y-4">
      <div className="rounded-2xl border bg-white p-4 shadow-sm">
        <div className="text-xl font-semibold">{c.business_and_full_name || c.fullname}</div>
        <div className="text-gray-600">{c.email}</div>
        <div className="text-gray-600">{c.phone || c.mobile}</div>
      </div>
      <div className="flex gap-2">
        <button className="btn" onClick={()=>goTo(`/$${id}?newticket`)}><Plus className="w-4 h-4"/> New Ticket</button>
        <a className="btn" href={`/$${id}?edit`} onClick={(e)=>{e.preventDefault(); goTo(`/$${id}?edit`);}}><ExternalLink className="w-4 h-4"/> Edit</a>
      </div>
    </div>
  );
}

function NewCustomer({ goTo }) {
  const api = useApi();
  const [form, setForm] = useState({ first_name: "", last_name: "", phone: "", email: "" });
  const [saving, setSaving] = useState(false);

  async function save() {
    setSaving(true);
    try {
      const data = await api.post(`/customers`, { customer: form });
      const c = data.customer || data;
      goTo(`/$${c.id}`);
    } catch(e) { console.error(e);} finally { setSaving(false);} 
  }

  return (
    <div className="mx-auto max-w-lg px-3 py-4">
      <div className="rounded-2xl border bg-white p-4 shadow-sm space-y-3">
        <div className="text-lg font-semibold">New Customer</div>
        {['first_name','last_name','phone','email'].map(k => (
          <div key={k} className="space-y-1">
            <label className="text-sm capitalize">{k.replace('_',' ')}</label>
            <input className="input w-full" value={form[k]} onChange={e=>setForm({...form, [k]: e.target.value})}/>
          </div>
        ))}
        <div className="flex justify-end gap-2">
          <button className="btn" onClick={save} disabled={saving}>{saving?"Saving…":"Create"}</button>
        </div>
      </div>
    </div>
  );
}

/*************************
 * Ticket View / Edit / New
 *************************/
function TicketView({ id, goTo }) {
  const api = useApi();
  const [t, setT] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(()=>{(async()=>{
    try {
      const data = await api.get(`/tickets/${id}`);
      setT(data.ticket || data);
    } catch (e) { console.error(e);} finally { setLoading(false);} })();
  }, [id, api]);

  if (loading) return <Loading/>;
  if (!t) return <ErrorMsg text="Ticket not found"/>;

  return (
    <div className="mx-auto max-w-4xl px-3 py-4 space-y-4">
      <div className="rounded-2xl border bg-white p-4 shadow-sm">
        <div className="flex items-center justify-between">
          <div className="text-xl font-semibold">Ticket #{t.number ?? t.id}</div>
          <div>
            <a className="btn" href={`/&${t.id}?edit`} onClick={(e)=>{e.preventDefault(); goTo(`/&${t.id}?edit`);}}>Edit</a>
          </div>
        </div>
        <div className="mt-2 grid grid-cols-2 gap-3 text-sm">
          <div><span className="text-gray-500">Subject:</span> {t.subject}</div>
          <div><span className="text-gray-500">Status:</span> {t.status}</div>
          <div><span className="text-gray-500">Customer:</span> {t.customer?.business_and_full_name}</div>
          <div><span className="text-gray-500">Created:</span> {fmtDate(t.created_at)}</div>
        </div>
      </div>

      <LabelCard ticket={t}/>
    </div>
  );
}

function LabelCard({ ticket }) {
  const labelRef = useRef(null);
  return (
    <div className="rounded-2xl border bg-white p-4 shadow-sm space-y-3">
      <div className="flex items-center justify-between"><div className="font-semibold">Ticket Label</div><button className="btn" onClick={()=>window.print()}><Printer className="w-4 h-4"/> Print</button></div>
      <div ref={labelRef} className="rounded-xl border p-4">
        <div className="font-mono">Ticket #{ticket.number ?? ticket.id}</div>
        <div>{ticket.subject}</div>
        <div className="text-sm text-gray-600">{ticket.customer?.business_and_full_name} • {ticket.customer?.phone}</div>
      </div>
    </div>
  );
}

function TicketEditor({ ticketId, customerId, goTo }) {
  const api = useApi();
  const [pre, setPre] = useState(null); // preloaded ticket or customer
  const [loading, setLoading] = useState(true);
  const [deviceIdx, setDeviceIdx] = useState(0);
  const [brandIdx, setBrandIdx] = useState(0);
  const [model, setModel] = useState("");
  const [colorIdx, setColorIdx] = useState(-1);
  const [problems, setProblems] = useState([]); // indexes
  const [howLongIdx, setHowLongIdx] = useState(0);
  const [password, setPassword] = useState("");
  const [itemsLeft, setItemsLeft] = useState([]); // strings
  const [needDataIdx, setNeedDataIdx] = useState(0);
  const [other, setOther] = useState("");
  const [subject, setSubject] = useState(""); // legacy subject panel support
  const [useLegacySubject, setUseLegacySubject] = useState(false);
  const [saving, setSaving] = useState(false);

  // preload context
  useEffect(()=>{
    (async()=>{
      try {
        if (ticketId) {
          const data = await api.get(`/tickets/${ticketId}`);
          const t = data.ticket || data;
          setPre(t);
          setSubject(t.subject || "");
          setPassword(t.password || "");
        } else if (customerId) {
          const data = await api.get(`/customers/${customerId}`);
          setPre(data.customer || data);
        }
      } catch (e) { console.error(e);} finally { setLoading(false);} 
    })();
  }, [ticketId, customerId, api]);

  function toggleProblem(i){ setProblems(p => p.includes(i) ? p.filter(x=>x!==i) : [...p, i]); }
  function toggleItem(name){ setItemsLeft(xs => xs.includes(name) ? xs.filter(x=>x!==name) : [...xs, name]); }

  async function save() {
    setSaving(true);
    try {
      let payload;
      if (useLegacySubject) {
        payload = { ticket: { subject, customer_id: customerId || pre?.customer_id, password, has_device: itemsLeft.includes("Charger"), } };
      } else {
        const arrival = new Date();
        const promised = HOW_LONG_MIN[howLongIdx] ? new Date(arrival.getTime() + HOW_LONG_MIN[howLongIdx]*60000) : arrival;
        payload = { ticket: {
          subject: buildSubject(),
          customer_id: customerId || pre?.customer_id || pre?.id,
          device_type: DEVICES[deviceIdx],
          brand: BRANDS[deviceIdx][brandIdx],
          model,
          color: colorIdx>=0 ? COLORS[colorIdx] : "",
          problems: problems.map(i=>PROBLEMS[deviceIdx][i]),
          notes: other,
          need_data: NEED_DATA[needDataIdx],
          password,
          promised_by: promised.toISOString(),
        }};
      }
      let out;
      if (ticketId) out = await api.put(`/tickets/${ticketId}`, payload);
      else out = await api.post(`/tickets`, payload);
      const t = out.ticket || out;
      goTo(`/&${t.id}`);
    } catch (e) { console.error(e);} finally { setSaving(false);} 
  }

  function buildSubject() {
    const bits = [BRANDS[deviceIdx][brandIdx], model, colorIdx>=0?COLORS[colorIdx]:null, DEVICES[deviceIdx]].filter(Boolean);
    const probs = problems.map(i=>PROBLEMS[deviceIdx][i]);
    const extra = other?.trim();
    return [bits.join(" "), probs.join(" + "), extra].filter(Boolean).join(" — ");
  }

  if (loading) return <Loading/>;

  return (
    <div className="mx-auto max-w-4xl px-3 py-4 space-y-4">
      <div className="rounded-2xl border bg-white p-4 shadow-sm space-y-4">
        <div className="flex items-center justify-between">
          <div className="text-lg font-semibold">{ticketId?"Edit Ticket":"New Ticket"}</div>
          <div className="flex items-center gap-2 text-sm">
            <label className="flex items-center gap-2"><input type="checkbox" checked={useLegacySubject} onChange={e=>setUseLegacySubject(e.target.checked)}/> Legacy subject panel</label>
            <button className="btn" onClick={save} disabled={saving}>{saving?"Saving…":"Apply"}</button>
          </div>
        </div>

        {!useLegacySubject ? (
          <div className="space-y-6">
            <PickerRow label="Device" options={DEVICES} value={deviceIdx} onChange={setDeviceIdx}/>
            <PickerRow label="Brand" options={BRANDS[deviceIdx]} value={brandIdx} onChange={setBrandIdx}/>
            <Field label="Model" value={model} onChange={setModel}/>
            <ColorRow value={colorIdx} onChange={setColorIdx}/>
            <MultiRow label="Problems" options={PROBLEMS[deviceIdx]} selected={problems} onToggle={toggleProblem}/>
            <PickerRow label="How long" options={HOW_LONG} value={howLongIdx} onChange={setHowLongIdx}/>
            <Field label="Password" value={password} onChange={setPassword} type="text"/>
            <Checkboxes label="Items left" options={ITEMS_LEFT} values={itemsLeft} onToggle={toggleItem}/>
            <PickerRow label="Data" options={NEED_DATA} value={needDataIdx} onChange={setNeedDataIdx}/>
            <TextArea label="Other" value={other} onChange={setOther}/>
            <div className="text-sm text-gray-500">Subject preview: <span className="font-medium">{buildSubject()}</span></div>
          </div>
        ) : (
          <Field label="Subject" value={subject} onChange={setSubject}/>
        )}
      </div>
    </div>
  );
}

/*************************
 * Small UI helpers
 *************************/
function PickerRow({ label, options, value, onChange }) {
  return (
    <div>
      <div className="text-sm text-gray-600 mb-2">{label}</div>
      <div className="flex flex-wrap gap-2">
        {options.map((x, i) => (
          <button key={i} onClick={()=>onChange(i)} className={classNames("chip", value===i && "chip-active")}>{x||"Other"}</button>
        ))}
      </div>
    </div>
  );
}
function MultiRow({ label, options, selected, onToggle }) {
  return (
    <div>
      <div className="text-sm text-gray-600 mb-2">{label}</div>
      <div className="flex flex-wrap gap-2">
        {options.map((x, i)=> (
          <button key={i} onClick={()=>onToggle(i)} className={classNames("chip", selected.includes(i) && "chip-active")}>{x}</button>
        ))}
      </div>
    </div>
  );
}
function ColorRow({ value, onChange }) {
  return (
    <div>
      <div className="text-sm text-gray-600 mb-2">Color</div>
      <div className="flex flex-wrap gap-2">
        {COLORS.map((c, i) => (
          <button key={c} onClick={()=>onChange(i)} className={classNames("px-3 py-1 rounded-full border text-sm", value===i && "ring-2 ring-black")}>{c}</button>
        ))}
      </div>
    </div>
  );
}
function Field({ label, value, onChange, type="text" }) {
  return (
    <div className="space-y-1">
      <label className="text-sm text-gray-600">{label}</label>
      <input className="input w-full" type={type} value={value} onChange={e=>onChange(e.target.value)} />
    </div>
  );
}
function TextArea({ label, value, onChange }) {
  return (
    <div className="space-y-1">
      <label className="text-sm text-gray-600">{label}</label>
      <textarea className="input w-full h-28" value={value} onChange={e=>onChange(e.target.value)} />
    </div>
  );
}
function Checkboxes({ label, options, values, onToggle }) {
  return (
    <div>
      <div className="text-sm text-gray-600 mb-2">{label}</div>
      <div className="flex flex-wrap gap-3">
        {options.map(o => o && (
          <label key={o} className="inline-flex items-center gap-2 text-sm">
            <input type="checkbox" checked={values.includes(o)} onChange={()=>onToggle(o)} /> {o}
          </label>
        ))}
      </div>
    </div>
  );
}
function Loading(){ return <div className="mx-auto max-w-3xl px-3 py-10 text-center text-gray-600">Loading…</div>; }
function ErrorMsg({ text }){ return <div className="mx-auto max-w-3xl px-3 py-10 text-center text-red-600">{text}</div>; }

/*************************
 * App
 *************************/
export default function App() {
  const { path, navigate } = useRoute();
  const [showSettings, setShowSettings] = useState(false);
  const searchRef = useRef(null);

  const route = useMemo(()=>{
    // parse path like Unity: "/$123?edit", "/&456" , "/#789", "/newcustomer"
    const p = path;
    const url = new URL(window.location.origin + p);
    const pathname = url.pathname;
    const query = url.searchParams;
    if (pathname === "/newcustomer") return { view: "newcustomer" };
    if (pathname.startsWith("/$")) {
      const id = pathname.slice(2);
      if (query.has("newticket")) return { view: "ticket-editor", customerId: id };
      if (query.has("edit")) return { view: "customer-edit", id };
      return { view: "customer", id };
    }
    if (pathname.startsWith("/&")) {
      const id = pathname.slice(2);
      if (query.has("edit")) return { view: "ticket-editor", ticketId: id };
      return { view: "ticket", id };
    }
    if (pathname.startsWith("/#")) {
      const number = pathname.slice(2);
      return { view: "ticket-by-number", number };
    }
    return { view: "home" };
  }, [path]);

  return (
    <ApiProvider>
      <div className="min-h-screen bg-gradient-to-b from-gray-50 to-white text-gray-900">
        <TopBar
          title={route.view==="home"?"Cacell System":"Cacell System"}
          onHome={()=>navigate("/")}
          onSearchFocus={()=>searchRef.current?.focus()}
          onNewCustomer={()=>navigate("/newcustomer")}
          onSettings={()=>setShowSettings(true)}
        />

        {route.view==="home" && <TicketListView goTo={navigate} focusSearchRef={searchRef} />}
        {route.view==="customer" && <CustomerView id={route.id} goTo={navigate} />}
        {route.view==="newcustomer" && <NewCustomer goTo={navigate} />}
        {route.view==="ticket" && <TicketView id={route.id} goTo={navigate} />}
        {route.view==="ticket-by-number" && <TicketByNumber number={route.number} goTo={navigate} />}
        {route.view==="ticket-editor" && <TicketEditor ticketId={route.ticketId} customerId={route.customerId} goTo={navigate} />}

        <SettingsModal open={showSettings} onClose={()=>setShowSettings(false)} />
      </div>
    </ApiProvider>
  );
}

function TicketByNumber({ number, goTo }) {
  const api = useApi();
  const [id, setId] = useState(null);
  const [err, setErr] = useState(null);
  useEffect(()=>{(async()=>{
    try {
      // Try to search ticket by number
      const data = await api.get(`/tickets?number=${encodeURIComponent(number)}`);
      const t = (data.tickets||[])[0];
      if (t) setId(t.id); else setErr("Ticket not found by number");
    } catch(e) { console.error(e); setErr("Ticket not found by number"); }
  })();}, [number, api]);
  if (err) return <ErrorMsg text={err}/>;
  if (!id) return <Loading/>;
  return <TicketView id={id} goTo={goTo}/>;
}

/*************************
 * Tailwind helper classes
 *************************/
const style = document.createElement('style');
style.innerHTML = `
  .btn{ @apply inline-flex items-center gap-2 px-3 py-1.5 rounded-xl border bg-white shadow-sm text-sm hover:bg-gray-50; }
  .icon-btn{ @apply inline-flex items-center justify-center w-9 h-9 rounded-xl border bg-white shadow-sm hover:bg-gray-50; }
  .input{ @apply px-3 py-2 rounded-xl border bg-white shadow-inner outline-none focus:ring-2 ring-black/10; }
  .chip{ @apply px-3 py-1 rounded-full border text-sm hover:bg-gray-50; }
  .chip-active{ @apply ring-2 ring-black; }
  .tab{ @apply px-3 py-1.5 rounded-xl text-sm; }
  .tab-active{ @apply bg-white shadow-sm border; }
`;
document.head.appendChild(style);
